<!DOCTYPE html>
<meta http-equiv="X-UA-Compatible" />
<html>
<head>
  <style>
	html, body {
	  margin: 0;
	  padding: 0;
	  font-family: "Helvetica", Sans-Serif;
	  color: #333333;
      background-color: #FFFFFF;
	}

    .chat-container {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 10px;
      box-sizing: border-box;
      background-color: #FFFFFF;
	  overflow-y: hidden;
	  overflow-x: auto;
    }

    .message {
      width: 80vw;
      border: 1px solid #E0E0E0;
      border-radius: 10px;
      padding: 10px;
      margin: 5px 0;
      box-sizing: border-box;
	  overflow: auto;
      background-color: #F5F5F5;
    }

    /* Rest of the CSS remains the same but with the placeholders replaced */
    .from-system {
      width: calc(100vw - 20px);
      align-self: center;
    }

    .from-me {
      align-self: flex-start;
    }

    .from-them {
      align-self: flex-end;
    }

	.details {
	  margin: 5px 0;
	}

	summary {
	  cursor: pointer;
	  font-weight: bold;
	  color: #333333;
	}

	blockquote {
	  border-left: 2px solid #E0E0E0;
	  margin: 10px 0;
	  padding-left: 10px;
	  background: #F5F5F5;
	}

	.attachment-container {
	  position: relative;
	  display: inline-block;
	  margin-left: 5px;
	}

	.attachment-icon {
	  font-size: 16px;
	  color: #333333;
	  cursor: pointer;
	}

	.tooltip {
	  display: none;
	  width: max-content;
	  max-width: 300px;
	  background-color: #FFFFFF;
	  color: #333333;
	  text-align: left;
	  padding: 8px 10px;
	  border-radius: 4px;
	  border: 1px solid #E0E0E0;
	  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
	  z-index: 100;
	  
	  /* Positioning relative to container */
	  position: absolute;
	  bottom: 30px;
	  left: 0;
	}

	/* Tooltip arrow */
	.tooltip::after {
	  content: "";
	  position: absolute;
	  top: 100%;
	  left: 10px;
	  border-width: 5px;
	  border-style: solid;
	  border-color: #FFFFFF transparent transparent transparent;
	}

	.attachment-container:hover .tooltip {
	  display: block;
	}

	.code-block {
	  position: relative;
	  margin: 1em 0;
	  border: 1px solid #E0E0E0;
	  border-radius: 6px;
	  overflow: hidden;
	}

	.code-block-header {
	  position: absolute;
	  display: flex;
	  justify-content: flex-end;
	  padding: 5px;
	  background-color: #E0E0E0;
	  border: 1px solid #BFBFBF;
	  border-radius: 4px;
	  top: 5px;
	  right: 5px;
	  z-index: 100;
	  opacity: 0;
	  transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
	  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
	  pointer-events: auto;
	}

	.code-block:hover .code-block-header {
	  opacity: 1;
	}

	/* Ensure the floating header doesn't disappear when mouse leaves the header itself */
	.floating-header:hover {
	  opacity: 1 !important;
	}

	.copy-button {
	  background-color: #FFFFFF;
	  border: 1px solid #CCCCCC;
	  color: #333333;
	  cursor: pointer;
	  font-size: 12px;
	  padding: 3px 8px;
	  border-radius: 4px;
	  margin-left: 5px;
	}

	.code-block pre {
	  margin: 0;
	  padding: 10px;
	  overflow: auto;
	}

	.floating-header {
	  position: fixed !important;
	  top: 10px !important;
	  right: 27px !important;
	  z-index: 1000 !important;
	}

	/* Add this to the style section in chat-template.html */
    .message-footer {
      display: flex;
      justify-content: flex-end;
      padding: 5px;
      margin-top: 8px;
      border-top: 1px solid #E0E0E0;
    }
    
    .message-button {
      background-color: #FFFFFF;
      border: 1px solid #CCCCCC;
      color: #333333;
      cursor: pointer;
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 4px;
      margin-left: 5px;
    }

	/* Table Styles */
	table {
	  width: 100%;
	  border-collapse: collapse;
	  margin: 15px 0;
	  border: 1px solid #bfbfbf;
	  border-radius: 10px;
	  overflow: hidden;
	  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
	  background-color: #ffffff;
	}

	th,
	td {
	  padding: 10px 12px;
	  text-align: left;
	  border-bottom: 1px solid #bfbfbf;
	  border-right: 1px solid #bfbfbf; /* Add vertical lines */
	}

	th {
	  background-color: #f5f5f5;
	  font-weight: bold;
	  color: #333333;
	  border-bottom: 2px solid #bfbfbf;
	}

	/* Remove the right border from the last cell in each row */
	th:last-child,
	td:last-child {
	  border-right: none;
	}

	tr:nth-child(even) {
	  background-color: #f9f9f9;
	}

	tr:hover {
	  background-color: #f0f0f0;
	}

	/* Responsive adjustments */
	@media (max-width: 768px) {
	  table,
	  thead,
	  tbody,
	  th,
	  td,
	  tr {
	    display: block;
	  }

	  thead tr {
	    position: absolute;
	    top: -9999px;
	    left: -9999px;
	  }

	  tr {
	    margin-bottom: 10px;
	    border: 1px solid #bfbfbf;
	    border-radius: 10px;
	  }

	  td {
	    border: none;
	    border-bottom: 1px solid #bfbfbf;
	    position: relative;
	    padding-left: 50%;
	    white-space: normal;
	  }

	  td:before {
	    position: absolute;
	    top: 6px;
	    left: 6px;
	    width: 45%;
	    padding-right: 10px;
	    white-space: nowrap;
	    content: attr(data-label);
	    font-weight: bold;
	  }

	  td:last-child {
	    border-bottom: 0;
	  }
      /* Remove vertical lines in responsive mode */
      td, th {
          border-right: none;
      }
    }

    /* Function call parameter and result styles */
    .function-params-container,
    .function-results-container {
      width: 100%;
      margin: 15px 0;
      border: 1px solid #bfbfbf;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      background-color: #ffffff;
    }

    .params-header,
    .results-header {
      padding: 10px 12px;
      background-color: #f5f5f5;
      font-weight: bold;
      color: #333333;
      border-bottom: 2px solid #bfbfbf;
    }

    .param-name,
    .result-name {
      padding: 10px 12px;
      font-weight: bold;
      background-color: #f9f9f9;
      border-bottom: 1px solid #bfbfbf;
    }

    .param-value,
    .result-value {
      padding: 10px 12px;
      border-bottom: 1px solid #bfbfbf;
      background-color: #ffffff;
      white-space: pre-wrap;
    }

    /* Remove bottom border from the last value in a container */
    .function-params-container > .param-value:last-child,
    .function-results-container > .result-value:last-child {
      border-bottom: none;
    }

	.tool-actions {
      margin-top: 10px;
      text-align: right; /* Adjust alignment as needed */
    }

    .tool-action-button {
      background-color: #FFFFFF;
      border: 1px solid #CCCCCC;
      color: #333333;
      cursor: pointer;
      font-size: 12px;
      padding: 5px 8px;
      border-radius: 4px;
      margin-left: 5px;
      display: inline-flex; /* Helps align icon and text */
      align-items: center;
      gap: 5px; /* Space between icon (if any) and text */
    }

    .tool-action-button:hover {
      background-color: #F0F0F0; /* Or your theme's hover color */
    }

    /* Ensure img within button is aligned if not handled by inline styles */
    .tool-action-button img {
      vertical-align: middle;
    }
  </style>

  <style>
	.spinner {
	  margin: 2px 2px 0;
	  width: 36px;
	  text-align: left;
	}

	.spinner > div {
	  width: 12px;
	  height: 12px;
	  background-color: #333333;

	  border-radius: 100%;
	  display: inline-block;
	  -webkit-animation: spinner-pulsedelay 1.4s infinite ease-in-out both;
	  animation: spinner-pulsedelay 1.4s infinite ease-in-out both;
	}

	.spinner .pulse1 {
	  -webkit-animation-delay: -0.48s;
	  animation-delay: -0.48s;
	}

	.spinner .pulse2 {
	  -webkit-animation-delay: -0.24s;
	  animation-delay: -0.24s;
	}

	@-webkit-keyframes spinner-pulsedelay {
	  0%, 80%, 100% { -webkit-transform: scale(0.5) }
	  40% { -webkit-transform: scale(1.0) }
	}

	@keyframes spinner-pulsedelay {
	  0%, 80%, 100% { 
	    -webkit-transform: scale(0.5);
	    transform: scale(0.5);
	  } 40% { 
	    -webkit-transform: scale(1.0);
	    transform: scale(1.0);
	  }
	}
	
	.spinner-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }
    
    .scroll-pause-button {
      cursor: pointer;
      background: transparent;
      color: var(--text-color);
      padding-top: 6px;
      border-radius: 4px;
      opacity: 0.7;
      transition: opacity 0.2s;
	  margin-left: auto;
    }
    
    .scroll-pause-button:hover {
      opacity: 1;
      background-color: var(--hover-color);
	}

    .scroll-to-bottom-button {
      position: fixed;
      bottom: 5px;
      right: 5px;
      z-index: 1000;
      padding: 8px 16px;
	  background: #F5F5F5;
	  color: var(--text-color);
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
  
  
  <!-- ADD PRISM CSS HERE -->
</head>
<body>

<div id="chat-container" class="chat-container">
</div>
<div id='bottom' style='visibility: hidden;'></div>

<script>
var autoScrollEnabled = true;
var darkTheme = false;

function isScrolledToBottom() {
  var bottomElement = document.getElementById("bottom");
  var rect = bottomElement.getBoundingClientRect();
  
  // Check if bottom element is visible in the viewport
  // or just below it (within a small margin of 50px)
  return (rect.top <= window.innerHeight + 50);
}

/**
 * Adds a new message to the chat container.
 * @param {String} uuid - Unique identifier for the message.
 * @param {String} role - The role of the sender ("assistant" or "user").
 * @param {String} content - The HTML content of the message.
 */
 function addMessage(uuid, role, content, updating=false) {
   const scrolledToBottom = isScrolledToBottom();
   
   var container = document.getElementById("chat-container");
   if (!container) {
     return;
   }
   var div = document.createElement("div");

   // Choose the correct CSS class based on the role
   if (role === "assistant") {
     div.className = "message from-them";
   } else if (role === "user") {
     div.className = "message from-me";
	 } else if (role === "system") {
	   div.className = "message from-system";
   } else if (role === "tool_summary") {
     div.className = "message from-system";
   } else {
     div.className = "message";
   }

   // Set the uuid as the element's id for future reference
   div.id = uuid;
   
   // Create a content div for the message content
   var contentDiv = document.createElement("div");
   contentDiv.className = "message-content";
   contentDiv.innerHTML = content;
   div.appendChild(contentDiv);
         
   // Process code blocks to add copy buttons
   processCodeBlocks(contentDiv);
   
   // Process attachments to add double-click functionality
   processAttachments(contentDiv);

   if(updating && role === "assistant") {
     var spinnerContainer = document.createElement("div");
     spinnerContainer.className = "spinner-container";
     
     // Add the spinner
     var spinner = document.createElement("div");
     spinner.className = "spinner";
     spinner.innerHTML = '<div class="pulse1"></div><div class="pulse2"></div><div class="pulse3"></div>';
     spinnerContainer.appendChild(spinner);
     
     // Add scroll control button
      var scrollPauseButton = document.createElement("button");
	 scrollPauseButton.id = "scroll-pause-button";
      scrollPauseButton.className = "message-button scroll-pause-button";
	 scrollPauseButton.title = "Pause auto-scrolling";
     
      setPauseIcon(scrollPauseButton);
      
       scrollPauseButton.onclick = function() {
         autoScrollEnabled = false; 
       };
      
      spinnerContainer.appendChild(scrollPauseButton);
	   
      div.appendChild(spinnerContainer);
      
      // Create the scroll to bottom button if it doesn't exist yet
      createScrollToBottomButton();
   }

   // Add a footer with buttons
   if (role !== "system") {  // Skip for system messages
     var footer = document.createElement("div");
     footer.className = "message-footer";
     
     // Add copy button
	 var copyButton = document.createElement("button");
	 copyButton.className = "message-button";
	 copyButton.title = "Copy";
	 setCopyButtonIcon(copyButton);
	 copyButton.onclick = function() {
       showCheckIconFeedback(copyButton);

	   // Call the Java callback
	   messageCopyClicked("copy:" + uuid);
	 };

     footer.appendChild(copyButton);
     
	 // Add edit button only for user messages
	 if (role === "user") {
	   var editButton = document.createElement("button");
	   editButton.className = "message-button";
	   editButton.title = "Edit";
	   setEditButtonIcon(editButton);
	   editButton.onclick = function() {
	     elementClicked("edit:" + uuid);
	   };
	   
	   footer.appendChild(editButton);
	 }
     
     div.appendChild(footer);
   }

   container.appendChild(div);

   if (scrolledToBottom && !isScrolledToBottom()) {
     const bottom = document.getElementById("bottom");
     if (bottom) {
       bottom.scrollIntoView({ block: 'start', behaviour: 'instant' });
     }
   }

   updateScrollToBottomButtonVisibility();
 }

/**
 * Updates an existing message's content.
 * @param {String} uuid - Unique identifier for the message to update.
 * @param {String} updatedContent - The new HTML content for the message.
 */
 function updateMessage(uuid, updatedContent) {
   const scrolledToBottom = isScrolledToBottom();

   var message = document.getElementById(uuid);
   if (message) {
     // Find the content div within the message
     var contentDiv = message.querySelector('.message-content');
     
     // Update the content
     if (contentDiv) {
       contentDiv.innerHTML = updatedContent;
       
       // Process code blocks to add copy buttons
       processCodeBlocks(contentDiv);

	   // Process attachments for double click
	   processAttachments(contentDiv);
      }
   }

   // Only scroll if auto-scroll is enabled
   if (autoScrollEnabled) {
     var bottom = document.getElementById("bottom");
     bottom.scrollIntoView(true);
   }
    var scrollPauseButton = document.getElementById("scroll-pause-button");
    if(scrollPauseButton) {
      scrollPauseButton.style.visibility = autoScrollEnabled ? "visible" : "hidden";
    }

    if (scrolledToBottom && !isScrolledToBottom()) {
      const bottom = document.getElementById("bottom");
      if (bottom) {
        bottom.scrollIntoView({ block: 'start', behaviour: 'instant' });
      }
    }

    updateScrollToBottomButtonVisibility();
  }

 /**
  * Removes the spinner from a completed chat message
  * @param {String} uuid - Unique identifier for the message to update.
  */
  function markMessageFinished(uuid) {
	var message = document.getElementById(uuid);
	if (message) {
	  // Find the spinner element within the content div
      var spinnerElement = message.querySelector('div.spinner-container');
      // If the spinner element exists, remove it
      if (spinnerElement) {
          spinnerElement.remove();
      }
	}

	// Remove scroll-resume-button.
    var resumeButton = document.getElementById("scroll-resume-button");
    if (resumeButton) {
      resumeButton.remove();
    }
  }

/**
 * Removes the spinner from all chat messages (if present).
 */
 function markAllMessagesFinished() {
    var spinners = document.querySelectorAll('div.spinner');

    spinners.forEach(function(spinnerElement) {
        if (spinnerElement) {
            spinnerElement.remove();
        }
    });
 }


/**
 * Processes code blocks within a container to add copy buttons.
 * @param {HTMLElement} container - The container element to search for code blocks.
 */
 /**
   /**
  * Processes code blocks within a container to add copy and apply buttons.
  * @param {HTMLElement} container - The container element to search for code blocks.
  */
 /**
 * Processes code blocks within a container to add copy and apply buttons.
 * @param {HTMLElement} container - The container element to search for code blocks.
 */
function processCodeBlocks(container) {
  var preElements = container.getElementsByTagName('pre');
  
  for (var i = 0; i < preElements.length; i++) {
    var preElement = preElements[i];
    var codeElement = preElement.querySelector('code');
    
    // Skip if already processed
    if (preElement.parentNode.className.indexOf('code-block') !== -1) {
      continue;
    }

    // Create wrapper container
    var codeBlock = document.createElement('div');
    codeBlock.className = 'code-block';
 
    if(window.Prism) {
      window.Prism.highlightElement(codeElement || preElement);
    }
    
    // Create header for the buttons
    var codeBlockHeader = document.createElement('div');
    codeBlockHeader.className = 'code-block-header';
    
    // Create the apply button
    var applyButton = document.createElement('button');
    applyButton.className = 'copy-button';
    applyButton.title = 'Apply to Editor';
    setApplyButtonIcon(applyButton);
    
    // Create the copy button
    var copyButton = document.createElement('button');
    copyButton.className = 'copy-button';
    copyButton.title = 'Copy';
    setCopyButtonIcon(copyButton);
    
    // Add buttons to header
    codeBlockHeader.appendChild(applyButton);
    codeBlockHeader.appendChild(copyButton);
    
    // Insert the code block elements
    preElement.parentNode.insertBefore(codeBlock, preElement);
    codeBlock.appendChild(codeBlockHeader);
    codeBlock.appendChild(preElement);
    
    // Attach click events to the buttons
    attachApplyEvent(applyButton, codeElement || preElement);
    attachCopyEvent(copyButton, codeElement || preElement);
    
    // Add smart positioning for the header
    (function(block, header) {
      // Function to update header position based on visibility
      function updateHeaderPosition() {
        var blockRect = block.getBoundingClientRect();
        
        // If the code block is visible at all
        if (blockRect.bottom > 0 && blockRect.top < window.innerHeight) {
          // If the top of the block is not visible (scrolled up out of view)
          if (blockRect.top < 0) {
            header.classList.add('floating-header');
          } else {
            header.classList.remove('floating-header');
          }
          
          // Show header when code block is visible and either hovered or floating
          if (block.matches(':hover')) {
            header.style.opacity = '1';
          } else {
            header.style.opacity = '';
          }
        } else {
          // Hide header when code block is not visible
          header.classList.remove('floating-header');
          header.style.opacity = '';
        }
      }
      
      // Listen for scroll events
      window.addEventListener('scroll', updateHeaderPosition);
      
      // Listen for mouse enter/leave on the code block
      block.addEventListener('mouseenter', function() {
        updateHeaderPosition();
      });
      
      block.addEventListener('mouseleave', function() {
		updateHeaderPosition();
      });
      
      // Initial positioning check
      updateHeaderPosition();
    })(codeBlock, codeBlockHeader);
  }
}

  /**
  * Processes attachment containers to add double-click functionality.
  * @param {HTMLElement} container - The container element to search for attachment containers.
  */
  function processAttachments(container) {
    var attachmentContainers = container.getElementsByClassName('attachment-container');
 
    for (var i = 0; i < attachmentContainers.length; i++) {
      var attachmentContainer = attachmentContainers[i];
      const attachmentId = attachmentContainer.id; // Get the UUID from the id attribute
 
      attachmentContainer.addEventListener('dblclick', function(event) {

        // Prevent the event from bubbling up (important!)
        event.stopPropagation();

        // Call the Java callback with the attachment UUID
        attachmentDoubleClicked("attachment:" + attachmentId); // Consistent naming
      });
    }
  }

  function attachmentDoubleClicked(uuid) {
      elementClicked(uuid);
  }
  
 /**
  * Sets the appropriate apply icon SVG based on the current theme
  * @param {HTMLElement} button - The button element to update
  */
 function setApplyButtonIcon(button) {
   // SVG icons in base64 format
   const lightThemeIcon = "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcKICAgaGVpZ2h0PSIyNHB4IgogICB2aWV3Qm94PSIwIC05NjAgOTYwIDk2MCIKICAgd2lkdGg9IjI0cHgiCiAgIGZpbGw9IiMzMzMzMzMiCiAgIHZlcnNpb249IjEuMSIKICAgaWQ9InN2ZzQiCiAgIHNvZGlwb2RpOmRvY25hbWU9Im1vdmVfaXRlbV8yNGRwXzMzMzMzM19GSUxMMF93Z2h0NDAwX0dSQUQwX29wc3oyNC5zdmciCiAgIGlua3NjYXBlOnZlcnNpb249IjEuMi4yICg3MzJhMDFkYTYzLCAyMDIyLTEyLTA5KSIKICAgeG1sbnM6aW5rc2NhcGU9Imh0dHA6Ly93d3cuaW5rc2NhcGUub3JnL25hbWVzcGFjZXMvaW5rc2NhcGUiCiAgIHhtbG5zOnNvZGlwb2RpPSJodHRwOi8vc29kaXBvZGkuc291cmNlZm9yZ2UubmV0L0RURC9zb2RpcG9kaS0wLmR0ZCIKICAgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIgogICB4bWxuczpzdmc9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcwogICAgIGlkPSJkZWZzOCIgLz4KICA8c29kaXBvZGk6bmFtZWR2aWV3CiAgICAgaWQ9Im5hbWVkdmlldzYiCiAgICAgcGFnZWNvbG9yPSIjZmZmZmZmIgogICAgIGJvcmRlcmNvbG9yPSIjMDAwMDAwIgogICAgIGJvcmRlcm9wYWNpdHk9IjAuMjUiCiAgICAgaW5rc2NhcGU6c2hvd3BhZ2VzaGFkb3c9IjIiCiAgICAgaW5rc2NhcGU6cGFnZW9wYWNpdHk9IjAuMCIKICAgICBpbmtzY2FwZTpwYWdlY2hlY2tlcmJvYXJkPSIwIgogICAgIGlua3NjYXBlOmRlc2tjb2xvcj0iI2QxZDFkMSIKICAgICBzaG93Z3JpZD0iZmFsc2UiCiAgICAgaW5rc2NhcGU6em9vbT0iNDEuNzUiCiAgICAgaW5rc2NhcGU6Y3g9IjExLjU2ODg2MiIKICAgICBpbmtzY2FwZTpjeT0iMTIiCiAgICAgaW5rc2NhcGU6d2luZG93LXdpZHRoPSIyNTYwIgogICAgIGlua3NjYXBlOndpbmRvdy1oZWlnaHQ9IjEzNjkiCiAgICAgaW5rc2NhcGU6d2luZG93LXg9IjE5MTIiCiAgICAgaW5rc2NhcGU6d2luZG93LXk9Ii04IgogICAgIGlua3NjYXBlOndpbmRvdy1tYXhpbWl6ZWQ9IjEiCiAgICAgaW5rc2NhcGU6Y3VycmVudC1sYXllcj0ic3ZnNCIgLz4KICA8cGF0aAogICAgIGQ9Ik0gNjAwLC02MDAgViAtNzYwIEggMjAwIHYgNTYwIGggNDAwIHYgLTE2MCBoIDgwIHYgMTYwIHEgMCwzMyAtMjMuNSw1Ni41IFEgNjMzLC0xMjAgNjAwLC0xMjAgSCAyMDAgcSAtMzMsMCAtNTYuNSwtMjMuNSBRIDEyMCwtMTY3IDEyMCwtMjAwIHYgLTU2MCBxIDAsLTMzIDIzLjUsLTU2LjUgUSAxNjcsLTg0MCAyMDAsLTg0MCBoIDQwMCBxIDMzLDAgNTYuNSwyMy41IDIzLjUsMjMuNSAyMy41LDU2LjUgdiAxNjAgeiIKICAgICBpZD0icGF0aDQ0MSIgLz4KICA8cGF0aAogICAgIGQ9Im0gNDc0LC01MjAgaCA0ODYgdiA4MCBIIDQ3NCBsIDYyLDYyIC01Niw1OCAtMTYwLC0xNjAgMTYwLC0xNjAgNTYsNTggeiIKICAgICBpZD0icGF0aDIiIC8+Cjwvc3ZnPgo=";
   const darkThemeIcon = "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcKICAgaGVpZ2h0PSIyNHB4IgogICB2aWV3Qm94PSIwIC05NjAgOTYwIDk2MCIKICAgd2lkdGg9IjI0cHgiCiAgIGZpbGw9IiMzMzMzMzMiCiAgIHZlcnNpb249IjEuMSIKICAgaWQ9InN2ZzQiCiAgIHNvZGlwb2RpOmRvY25hbWU9Im1vdmVfaXRlbV8yNGRwX0NDQ0NDQ19GSUxMMF93Z2h0NDAwX0dSQUQwX29wc3oyNC5zdmciCiAgIGlua3NjYXBlOnZlcnNpb249IjEuMi4yICg3MzJhMDFkYTYzLCAyMDIyLTEyLTA5KSIKICAgeG1sbnM6aW5rc2NhcGU9Imh0dHA6Ly93d3cuaW5rc2NhcGUub3JnL25hbWVzcGFjZXMvaW5rc2NhcGUiCiAgIHhtbG5zOnNvZGlwb2RpPSJodHRwOi8vc29kaXBvZGkuc291cmNlZm9yZ2UubmV0L0RURC9zb2RpcG9kaS0wLmR0ZCIKICAgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIgogICB4bWxuczpzdmc9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcwogICAgIGlkPSJkZWZzOCIgLz4KICA8c29kaXBvZGk6bmFtZWR2aWV3CiAgICAgaWQ9Im5hbWVkdmlldzYiCiAgICAgcGFnZWNvbG9yPSIjZmZmZmZmIgogICAgIGJvcmRlcmNvbG9yPSIjMDAwMDAwIgogICAgIGJvcmRlcm9wYWNpdHk9IjAuMjUiCiAgICAgaW5rc2NhcGU6c2hvd3BhZ2VzaGFkb3c9IjIiCiAgICAgaW5rc2NhcGU6cGFnZW9wYWNpdHk9IjAuMCIKICAgICBpbmtzY2FwZTpwYWdlY2hlY2tlcmJvYXJkPSIwIgogICAgIGlua3NjYXBlOmRlc2tjb2xvcj0iI2QxZDFkMSIKICAgICBzaG93Z3JpZD0iZmFsc2UiCiAgICAgaW5rc2NhcGU6em9vbT0iNDEuNzUiCiAgICAgaW5rc2NhcGU6Y3g9IjExLjQzNzEyNiIKICAgICBpbmtzY2FwZTpjeT0iMTIiCiAgICAgaW5rc2NhcGU6d2luZG93LXdpZHRoPSIyNTYwIgogICAgIGlua3NjYXBlOndpbmRvdy1oZWlnaHQ9IjEzNjkiCiAgICAgaW5rc2NhcGU6d2luZG93LXg9IjE5MTIiCiAgICAgaW5rc2NhcGU6d2luZG93LXk9Ii04IgogICAgIGlua3NjYXBlOndpbmRvdy1tYXhpbWl6ZWQ9IjEiCiAgICAgaW5rc2NhcGU6Y3VycmVudC1sYXllcj0ic3ZnNCIgLz4KICA8cGF0aAogICAgIGQ9Ik0gNjAwLC02MDAgViAtNzYwIEggMjAwIHYgNTYwIGggNDAwIHYgLTE2MCBoIDgwIHYgMTYwIHEgMCwzMyAtMjMuNSw1Ni41IFEgNjMzLC0xMjAgNjAwLC0xMjAgSCAyMDAgcSAtMzMsMCAtNTYuNSwtMjMuNSBRIDEyMCwtMTY3IDEyMCwtMjAwIHYgLTU2MCBxIDAsLTMzIDIzLjUsLTU2LjUgUSAxNjcsLTg0MCAyMDAsLTg0MCBoIDQwMCBxIDMzLDAgNTYuNSwyMy41IDIzLjUsMjMuNSAyMy41LDU2LjUgdiAxNjAgeiIKICAgICBpZD0icGF0aDQ0MSIKICAgICBzdHlsZT0iZmlsbDojY2NjY2NjO2ZpbGwtb3BhY2l0eToxIiAvPgogIDxwYXRoCiAgICAgZD0ibSA0NzQsLTUyMCBoIDQ4NiB2IDgwIEggNDc0IGwgNjIsNjIgLTU2LDU4IC0xNjAsLTE2MCAxNjAsLTE2MCA1Niw1OCB6IgogICAgIGlkPSJwYXRoMiIKICAgICBzdHlsZT0iZmlsbDojY2NjY2NjO2ZpbGwtb3BhY2l0eToxIiAvPgo8L3N2Zz4K";
   
   // Choose the icon based on theme
   const iconSrc = darkTheme ? darkThemeIcon : lightThemeIcon;
   
   // Set button content to the SVG
   button.innerHTML = '';
   button.style.display = "flex";
   button.style.alignItems = "center";
   button.style.justifyContent = "center";
   button.style.padding = "5px 8px";
   button.style.transition = "opacity 0.7s ease-in-out";
   
   // Add the SVG image
   const img = document.createElement('img');
   img.src = "data:image/svg+xml;base64," + iconSrc;
   img.alt = "Apply";
   img.style.width = "16px";
   img.style.height = "16px";
   button.appendChild(img);
 }

 /**
  * Attaches a click event to the apply button to apply code to editor.
  * @param {HTMLElement} button - The apply button element.
  * @param {HTMLElement} codeBlock - The code block element.
  */
 function attachApplyEvent(button, codeBlock) {
   button.onclick = function() {
     showCheckIconFeedback(button);

     // Get the selected text or the whole code block
     var content = getSelectedTextInElement(codeBlock) || (codeBlock.innerText || codeBlock.textContent);
     elementClicked("apply:" + encodeURIComponent(content));
   };
 }

 /**
  * Attaches a click event to the copy button to copy code content.
  * @param {HTMLElement} button - The copy button element.
  * @param {HTMLElement} codeBlock - The code block element.
  */
 function attachCopyEvent(button, codeBlock) {
   button.onclick = function() {
     showCheckIconFeedback(button);

     // Get the selected text or the whole code block
     var content = getSelectedTextInElement(codeBlock) || (codeBlock.innerText || codeBlock.textContent);
     copyTextToClipboard(content);
   };
 }

 /**
  * Gets the selected text if it's within the given element.
  * @param {HTMLElement} element - The element to check selection within.
  * @returns {string|null} The selected text within the element, or null if no valid selection.
  */
 function getSelectedTextInElement(element) {
   // Get the current selection
   var selection = window.getSelection();
   
   // Check if there's a selection and it has text
   if (!selection || selection.rangeCount === 0 || selection.toString().trim() === '') {
     return null;
   }
   
   // Check if the selection is inside the element
   var range = selection.getRangeAt(0);
   var container = range.commonAncestorContainer;
   
   // Navigate up the DOM if needed
   while (container && container !== element && container.parentNode !== document.body) {
     container = container.parentNode;
   }
   
   // If the selection is within the element, return the selected text
   if (container === element || element.contains(container)) {
     return selection.toString();
   }
   
   return null;
 }

 /**
  * Copies text to clipboard.
  * @param {string} text - The text to copy.
  */
 function copyTextToClipboard(text) {
   var textarea = document.createElement('textarea');
   textarea.value = text;

   // Make the textarea off-screen
   textarea.style.position = 'fixed';
   textarea.style.top = '-1000px';
   textarea.style.left = '-1000px';

   document.body.appendChild(textarea);
   textarea.select();

   try {
     var successful = document.execCommand('copy');
     if (!successful) {
       console.error('Unable to copy text.');
     }
   } catch (err) {
     console.error('Copy feature is not supported in this browser.');
   }

   document.body.removeChild(textarea);
 }

 /**
  * Returns the appropriate check icon SVG based on the current theme
  * @returns {string} The base64 encoded SVG for a check icon
  */
 function getCheckIcon() {
   // SVG icons in base64 format
   const lightThemeIcon = "PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAtOTYwIDk2MCA5NjAiIHdpZHRoPSIyNHB4IiBmaWxsPSIjMzMzMzMzIj48cGF0aCBkPSJtMzgyLTM1NCAzMzktMzM5cTEyLTEyIDI4LTEydDI4IDEycTEyIDEyIDEyIDI4LjVUNzc3LTYzNkw0MTAtMjY4cS0xMiAxMi0yOCAxMnQtMjgtMTJMMTgyLTQ0MHEtMTItMTItMTEuNS0yOC41VDE4My00OTdxMTItMTIgMjguNS0xMnQyOC41IDEybDE0MiAxNDNaIi8+PC9zdmc+";
   const darkThemeIcon = "PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAtOTYwIDk2MCA5NjAiIHdpZHRoPSIyNHB4IiBmaWxsPSIjY2NjY2NjIj48cGF0aCBkPSJtMzgyLTM1NCAzMzktMzM5cTEyLTEyIDI4LTEydDI4IDEycTEyIDEyIDEyIDI4LjVUNzc3LTYzNkw0MTAtMjY4cS0xMiAxMi0yOCAxMnQtMjgtMTJMMTgyLTQ0MHEtMTItMTItMTEuNS0yOC41VDE4My00OTdxMTItMTIgMjguNS0xMnQyOC41IDEybDE0MiAxNDNaIi8+PC9zdmc+";
   
   // Choose the icon based on theme
   return darkTheme ? darkThemeIcon : lightThemeIcon;
 }

 /**
  * Shows a check icon as visual feedback for a successful copy operation
  * @param {HTMLElement} button - The button element to update
  */
 function showCheckIconFeedback(button) {
   // Save the original content of the button
   const originalContent = button.innerHTML;
   
   // Replace with check icon
   const checkIcon = getCheckIcon();
   button.innerHTML = '<img src="data:image/svg+xml;base64,' + checkIcon + '" alt="Copied" width="16" height="16" style="vertical-align: middle;">';
   
   // Restore original content after 1.5 seconds
   setTimeout(function() {
     button.innerHTML = originalContent;
   }, 1500);
 }

/**
 * Processes existing messages to add copy buttons to code blocks.
 */
function processExistingMessages() {
  var messages = document.getElementsByClassName('message');
  for (var i = 0; i < messages.length; i++) {
    processCodeBlocks(messages[i]);
  }
}

function messageCopyClicked(id) {
  // This function will be called by the Java BrowserFunction
  elementClicked(id);
}

/**
 * Detects if the current theme is dark or light based on the body's background color.
 * @returns {boolean} true if dark theme, false if light theme
 */
function detectTheme() {
  // Get the background color of the body
  const bodyBgColor = window.getComputedStyle(document.body).backgroundColor;
  
  // Parse the RGB values
  const rgb = bodyBgColor.match(/\d+/g);
  if (!rgb || rgb.length < 3) {
    // If we can't parse the color, default to light theme
    return false;
  }
  
  // Convert to integers
  const r = parseInt(rgb[0]);
  const g = parseInt(rgb[1]);
  const b = parseInt(rgb[2]);
  
  // Calculate perceived brightness using the formula that accounts for human perception
  // (the human eye is more sensitive to green, less to blue)
  const brightness = (0.299 * r + 0.587 * g + 0.114 * b);
  
  // If brightness is less than 128 (middle of 0-255 range), consider it dark
  return brightness < 128;
}

// Example usage:
function updateThemeSetting() {
  darkTheme = detectTheme();
}

/**
 * Returns an HTML img tag with the appropriate copy icon based on the current theme
 * @returns {string} An HTML img tag with the appropriate copy icon
 */
function getCopyIconHtml() {
  // Base64 encoded SVGs for light and dark themes
  const lightThemeSVG = "PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAtOTYwIDk2MCA5NjAiIHdpZHRoPSIyNHB4IiBmaWxsPSIjMzMzMzMzIj48cGF0aCBkPSJNMzYwLTI0MHEtMzMgMC01Ni41LTIzLjVUMjgwLTMyMHYtNDgwcTAtMzMgMjMuNS01Ni41VDM2MC04ODBoMzYwcTMzIDAgNTYuNSAyMy41VDgwMC04MDB2NDgwcTAgMzMtMjMuNSA1Ni41VDcyMC0yNDBIMzYwWm0wLTgwaDM2MHYtNDgwSDM2MHY0ODBaTTIwMC04MHEtMzMgMC01Ni41LTIzLjVUMTIwLTE2MHYtNTIwcTAtMTcgMTEuNS0yOC41VDE2MC03MjBxMTcgMCAyOC41IDExLjVUMjAwLTY4MHY1MjBoNDAwcTE3IDAgMjguNSAxMS41VDY0MC0xMjBxMCAxNy0xMS41IDI4LjVUNjAwLTgwSDIwMFptMTYwLTI0MHYtNDgwIDQ4MFoiLz48L3N2Zz4=";
  const darkThemeSVG = "PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAtOTYwIDk2MCA5NjAiIHdpZHRoPSIyNHB4IiBmaWxsPSIjY2NjY2NjIj48cGF0aCBkPSJNMzYwLTI0MHEtMzMgMC01Ni41LTIzLjVUMjgwLTMyMHYtNDgwcTAtMzMgMjMuNS01Ni41VDM2MC04ODBoMzYwcTMzIDAgNTYuNSAyMy41VDgwMC04MDB2NDgwcTAgMzMtMjMuNSA1Ni41VDcyMC0yNDBIMzYwWm0wLTgwaDM2MHYtNDgwSDM2MHY0ODBaTTIwMC04MHEtMzMgMC01Ni41LTIzLjVUMTIwLTE2MHYtNTIwcTAtMTcgMTEuNS0yOC41VDE2MC03MjBxMTcgMCAyOC41IDExLjVUMjAwLTY4MHY1MjBoNDAwcTE3IDAgMjguNSAxMS41VDY0MC0xMjBxMCAxNy0xMS41IDI4LjVUNjAwLTgwSDIwMFptMTYwLTI0MHYtNDgwIDQ4MFoiLz48L3N2Zz4=";
  
  // Select the appropriate SVG based on the theme
  const svgBase64 = darkTheme ? darkThemeSVG : lightThemeSVG;
  
  // Return the HTML img tag with the data URL
  return `<img src="data:image/svg+xml;base64,${svgBase64}" alt="Copy" width="16" height="16" style="vertical-align: middle;">`;
}

/**
 * Sets the appropriate copy icon SVG based on the current theme
 * @param {HTMLElement} button - The button element to update
 */
function setCopyButtonIcon(button) {
  // SVG icons in base64 format
  const lightThemeIcon = "PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAtOTYwIDk2MCA5NjAiIHdpZHRoPSIyNHB4IiBmaWxsPSIjMzMzMzMzIj48cGF0aCBkPSJNMzYwLTI0MHEtMzMgMC01Ni41LTIzLjVUMjgwLTMyMHYtNDgwcTAtMzMgMjMuNS01Ni41VDM2MC04ODBoMzYwcTMzIDAgNTYuNSAyMy41VDgwMC04MDB2NDgwcTAgMzMtMjMuNSA1Ni41VDcyMC0yNDBIMzYwWm0wLTgwaDM2MHYtNDgwSDM2MHY0ODBaTTIwMC04MHEtMzMgMC01Ni41LTIzLjVUMTIwLTE2MHYtNTIwcTAtMTcgMTEuNS0yOC41VDE2MC03MjBxMTcgMCAyOC41IDExLjVUMjAwLTY4MHY1MjBoNDAwcTE3IDAgMjguNSAxMS41VDY0MC0xMjBxMCAxNy0xMS41IDI4LjVUNjAwLTgwSDIwMFptMTYwLTI0MHYtNDgwIDQ4MFoiLz48L3N2Zz4=";
  const darkThemeIcon = "PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAtOTYwIDk2MCA5NjAiIHdpZHRoPSIyNHB4IiBmaWxsPSIjY2NjY2NjIj48cGF0aCBkPSJNMzYwLTI0MHEtMzMgMC01Ni41LTIzLjVUMjgwLTMyMHYtNDgwcTAtMzMgMjMuNS01Ni41VDM2MC04ODBoMzYwcTMzIDAgNTYuNSAyMy41VDgwMC04MDB2NDgwcTAgMzMtMjMuNSA1Ni41VDcyMC0yNDBIMzYwWm0wLTgwaDM2MHYtNDgwSDM2MHY0ODBaTTIwMC04MHEtMzMgMC01Ni41LTIzLjVUMTIwLTE2MHYtNTIwcTAtMTcgMTEuNS0yOC41VDE2MC03MjBxMTcgMCAyOC41IDExLjVUMjAwLTY4MHY1MjBoNDAwcTE3IDAgMjguNSAxMS41VDY0MC0xMjBxMCAxNy0xMS41IDI4LjVUNjAwLTgwSDIwMFptMTYwLTI0MHYtNDgwIDQ4MFoiLz48L3N2Zz4=";
  
  // Choose the icon based on theme
  const iconSrc = darkTheme ? darkThemeIcon : lightThemeIcon;
  
  // Set button content to the SVG
  button.innerHTML = '';
  button.style.display = "flex";
  button.style.alignItems = "center";
  button.style.justifyContent = "center";
  button.style.padding = "5px 8px";
  button.style.transition = "opacity 0.7s ease-in-out";
  
  // Add the SVG image
  const img = document.createElement('img');
  img.src = "data:image/svg+xml;base64," + iconSrc;
  img.alt = "Copy";
  img.style.width = "16px";
  img.style.height = "16px";
  button.appendChild(img);
}

/**
 * Sets the appropriate edit icon SVG based on the current theme
 * @param {HTMLElement} button - The button element to update
 */
function setEditButtonIcon(button) {
  // SVG icons in base64 format
  const lightThemeIcon = "PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAtOTYwIDk2MCA5NjAiIHdpZHRoPSIyNHB4IiBmaWxsPSIjMzMzMzMzIj48cGF0aCBkPSJNMjAwLTIwMGg1N2wzOTEtMzkxLTU3LTU3LTM5MSAzOTF2NTdabS00MCA4MHEtMTcgMC0yOC41LTExLjVUMTIwLTE2MHYtOTdxMC0xNiA2LTMwLjV0MTctMjUuNWw1MDUtNTA0cTEyLTExIDI2LjUtMTd0MzAuNS02cTE2IDAgMzEgNnQyNiAxOGw1NSA1NnExMiAxMSAxNy41IDI2dDUuNSAzMHEwIDE2LTUuNSAzMC41VDgxNy02NDdMMzEzLTE0M3EtMTEgMTEtMjUuNSAxN3QtMzAuNSA2aC05N1ptNjAwLTU4NC01Ni01NiA1NiA1NlptLTE0MSA4NS0yOC0yOSA1NyA1Ny0yOS0yOFoiLz48L3N2Zz4=";
  const darkThemeIcon = "PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAtOTYwIDk2MCA5NjAiIHdpZHRoPSIyNHB4IiBmaWxsPSIjY2NjY2NjIj48cGF0aCBkPSJNMjAwLTIwMGg1N2wzOTEtMzkxLTU3LTU3LTM5MSAzOTF2NTdabS00MCA4MHEtMTcgMC0yOC41LTExLjVUMTIwLTE2MHYtOTdxMC0xNiA2LTMwLjV0MTctMjUuNWw1MDUtNTA0cTEyLTExIDI2LjUtMTd0MzAuNS02cTE2IDAgMzEgNnQyNiAxOGw1NSA1NnExMiAxMSAxNy41IDI2dDUuNSAzMHEwIDE2LTUuNSAzMC41VDgxNy02NDdMMzEzLTE0M3EtMTEgMTEtMjUuNSAxN3QtMzAuNSA2aC05N1ptNjAwLTU4NC01Ni01NiA1NiA1NlptLTE0MSA4NS0yOC0yOSA1NyA1Ny0yOS0yOFoiLz48L3N2Zz4=";
  
  // Choose the icon based on theme
  const iconSrc = darkTheme ? darkThemeIcon : lightThemeIcon;
  
  // Set button content to the SVG
  button.innerHTML = '';
  button.style.display = "flex";
  button.style.alignItems = "center";
  button.style.justifyContent = "center";
  button.style.padding = "5px 8px";
  button.style.transition = "opacity 0.7s ease-in-out";
  
  // Add the SVG image
  const img = document.createElement('img');
  img.src = "data:image/svg+xml;base64," + iconSrc;
  img.alt = "Edit";
  img.style.width = "16px";
  img.style.height = "16px";
  button.appendChild(img);
}

// Functions to set pause and play icons
function setPauseIcon(button) {
  button.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 4H6V20H10V4Z" fill="currentColor"/><path d="M18 4H14V20H18V4Z" fill="currentColor"/></svg>';
}

function setPlayIcon(button) {
  button.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 4L18 12L6 20V4Z" fill="currentColor"/></svg>';
}

function setArrowDownIcon(button) {
  button.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5H7z" fill="currentColor"/></svg>';
}

/**
 * Creates and manages the resume scroll button.
 * This button appears in the lower right corner when auto-scrolling is disabled during updating.
 */
function createScrollToBottomButton() {
  // Check if button already exists
  var existingButton = document.getElementById("scroll-to-bottom-button");
  if (existingButton) {
    return existingButton;
  }
  
  // Create the button
  var scrollToBottomButton = document.createElement("button");
  scrollToBottomButton.id = "scroll-to-bottom-button";
  scrollToBottomButton.className = "message-button scroll-to-bottom-button";
  scrollToBottomButton.title = "Scroll to bottom";
  
  setArrowDownIcon(scrollToBottomButton);
  
  // Set initial state to hidden
  scrollToBottomButton.style.display = "none";
  
  // Add click event to resume scrolling
  scrollToBottomButton.onclick = function() {
    autoScrollEnabled = true;
    var bottom = document.getElementById("bottom");
    if (bottom) {
      bottom.scrollIntoView(true);
    }
  };
  
  // Add to document body
  document.body.appendChild(scrollToBottomButton);
  
  return scrollToBottomButton;
}

/**
 * Updates the visibility of the resume scroll button based on current state.
 * @param {Boolean} updating - Whether a message is currently being updated.
 */
function updateScrollToBottomButtonVisibility() {
  var scrollToBottomButton = createScrollToBottomButton();
  
  // Only show the button if auto-scroll is disabled AND we're updating a message
  if (!isScrolledToBottom()) {
    scrollToBottomButton.style.display = "block";
  } else {
    scrollToBottomButton.style.display = "none";
  }
}

function reexecuteFunctionCallJs(uuid, buttonElement) {
  // Show visual feedback on the button
  if (typeof showCheckIconFeedback === 'function') {
    showCheckIconFeedback(buttonElement);
  } else {
    console.warn("JavaScript Warning: showCheckIconFeedback function is not defined.");
  }

  // Call the Java backend
  if (window.elementClicked) {
    window.elementClicked("reexecute:" + uuid);
  } else {
    console.error("JavaScript Error: elementClicked function is not defined on window.");
  }
}

// Call the function after the page loads
window.onload = function() {
  processExistingMessages();

  // Initial check - are we at the bottom?
  autoScrollEnabled = isScrolledToBottom();

  updateThemeSetting();
  
  // Listen for scroll events on the window
  if (typeof window.onscrollend !== 'undefined') {
      window.addEventListener('scroll', () => autoScrollEnabled = false);
      window.addEventListener('scrollend', () => {
		autoScrollEnabled = isScrolledToBottom();
		updateScrollToBottomButtonVisibility();
      });
  } else {
      window.addEventListener('scroll', () => {
        autoScrollEnabled = isScrolledToBottom();
        updateScrollToBottomButtonVisibility();
      });
  }
};
</script>

<!-- ADD PRISM JS HERE -->
</body>
</html>
